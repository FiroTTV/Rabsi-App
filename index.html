<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rabsi â€“ Nail Streak ğŸ’…</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b1d3a">

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html,body{
    margin:0;
    padding:0;
    font-family:system-ui,sans-serif;
    min-height:100vh;
}
body{
    background:linear-gradient(135deg,#2b1d3a,#1e1e2f,#2a1f4f);
    display:flex;
    justify-content:center;
    padding:24px 0;
    color:#f0f0f0;
}
.app{
    background:linear-gradient(180deg,#1f1b2e,#181826);
    width:100%;
    max-width:420px;
    border-radius:24px;
    padding:24px;
    box-shadow:0 20px 40px rgba(0,0,0,.6);
}
.hidden{display:none}

h1,h2{text-align:center;margin-bottom:10px}

button{
    width:100%;
    padding:12px;
    border-radius:14px;
    border:none;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    margin-bottom:10px;
}
.buttons{display:flex;gap:10px}
.buttons button{width:50%}
.yes{background:#7be495;color:#000}
.no{background:#ff8a8a;color:#000}

.weekdays,.calendar{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:8px;
}
.weekdays{
    font-size:12px;
    opacity:.7;
    text-align:center;
    margin-bottom:6px;
}
.day{
    aspect-ratio:1;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    background:#333;
}
.future{background:#555}
.success{background:#4cd964!important;color:#000}
.fail{background:#ff5c5c!important}
.today{outline:3px solid #7a5cff}

.streak{
    background:#2a2a3d;
    border-radius:14px;
    padding:14px;
    text-align:center;
    font-size:20px;
    font-weight:700;
    margin-bottom:16px;
}

.gift{
    background:#2a2a3d;
    border-radius:14px;
    padding:14px;
    text-align:center;
    margin-bottom:10px;
}

.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:1000;
}
.modal-content{
    background:#1c1c28;
    border-radius:20px;
    padding:20px;
    width:90%;
    max-width:400px;
}
.stats-grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
    margin-top:10px;
}
.stats-grid div{
    aspect-ratio:1;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
}
input,select{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:none;
    margin-bottom:8px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="app" id="loginBox">
    <h2>ğŸ’œ Rabsi Login</h2>
    <input id="email" placeholder="E-Mail">
    <input id="password" type="password" placeholder="Passwort">
    <button onclick="login()">Einloggen / Registrieren</button>
</div>

<!-- APP -->
<div class="app hidden" id="appBox">
    <h2>ğŸ”¥ Rabsi's Nail-Streak</h2>

    <button onclick="openStats()">ğŸ“Š Statistik</button>
    <button onclick="openAccount()">âš™ï¸ Account</button>
    <button id="adminToggle">ğŸ‘‘ Admin: AUS</button>

    <div id="monthTitle"></div>
    <div class="streak" id="streakBox">ğŸ”¥ 0 Tage Streak</div>

    <div class="weekdays">
        <div>Mo</div><div>Di</div><div>Mi</div>
        <div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
    </div>

    <div class="calendar" id="calendar"></div>

    <div class="buttons">
        <button class="yes" id="btnYes">Heute nicht gekaut âœ…</button>
        <button class="no" id="btnNo">Heute gekaut âŒ</button>
    </div>

    <div class="gift" id="giftBox">ğŸ”’ Geschenk gesperrt</div>

    <button onclick="logout()">ğŸšª Logout</button>
</div>

<!-- STATISTIK -->
<div class="modal" id="statsModal">
<div class="modal-content">
<h3>ğŸ“Š Statistik</h3>
<select id="monthSelect"></select>
<div id="statsSummary"></div>
<div class="stats-grid" id="statsGrid"></div>
<button onclick="closeStats()">SchlieÃŸen</button>
</div>
</div>

<!-- ACCOUNT -->
<div class="modal" id="accountModal">
<div class="modal-content">
<h3>âš™ï¸ Account</h3>
<p><b>E-Mail:</b> <span id="accEmail"></span></p>
<p><b>UID:</b><br><small id="accUid"></small></p>
<p><b>Tage:</b> <span id="accDays"></span></p>

<hr>
<h4>ğŸ‘‘ Admin: Progress setzen</h4>
<input id="editEmail" placeholder="Account E-Mail">
<input id="editDate" type="date">
<select id="editValue">
<option value="success">âœ… clean</option>
<option value="fail">âŒ gekaut</option>
<option value="">â¬œ lÃ¶schen</option>
</select>
<button onclick="adminEditProgress()">ğŸ’¾ Speichern</button>

<button onclick="closeAccount()">SchlieÃŸen</button>
</div>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBjc2ti7FM5hRIzMrMxOsLIA_K5ulBRP3w",
  authDomain: "rabsi-nail-streak.firebaseapp.com",
  projectId: "rabsi-nail-streak",
  appId: "1:261656631522:web:9b79c2cbc0e1e8790126bb"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== LOGIN (iOS safe) ===== */
async function login(){
    const e=email.value.trim(), p=password.value.trim();
    if(!e||!p){alert("E-Mail & Passwort eingeben");return;}
    try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(e,p);
    }catch(err){
        if(err.code==="auth/user-not-found"){
            await auth.createUserWithEmailAndPassword(e,p);
        }else alert(err.message);
    }
}

/* ===== STATE ===== */
let data={}, isAdmin=localStorage.getItem("rabsiAdmin")==="1";
const today=new Date();
const year=today.getFullYear(), month=today.getMonth();
const daysInMonth=new Date(year,month+1,0).getDate();

/* ===== AUTH ===== */
auth.onAuthStateChanged(user=>{
    if(!user){
        loginBox.classList.remove("hidden");
        appBox.classList.add("hidden");
        return;
    }
    loginBox.classList.add("hidden");
    appBox.classList.remove("hidden");

    accEmail.textContent=user.email;
    accUid.textContent=user.uid;

    db.collection("users").doc(user.uid).set({
        email:user.email
    },{merge:true});

    db.collection("users").doc(user.uid).onSnapshot(doc=>{
        data=doc.data()?.streakData||{};
        accDays.textContent=Object.keys(data).length;
        buildCalendar();
        updateStreak();
        checkGift();
        updateAdminUI();
    });
});

/* ===== CALENDAR ===== */
monthTitle.textContent=today.toLocaleString("de-DE",{month:"long",year:"numeric"});
function keyFor(d){
    return `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}
function buildCalendar(){
    calendar.innerHTML="";
    const offset=(new Date(year,month,1).getDay()+6)%7;
    for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"));
    for(let d=1;d<=daysInMonth;d++){
        const el=document.createElement("div");
        el.className="day";
        el.textContent=d;
        const k=keyFor(d);
        const dt=new Date(year,month,d);
        if(data[k]==="success")el.classList.add("success");
        if(data[k]==="fail")el.classList.add("fail");
        if(dt>today)el.classList.add("future");
        if(d===today.getDate())el.classList.add("today");
        calendar.appendChild(el);
    }
}

/* ===== STREAK ===== */
function updateStreak(){
    const tk=keyFor(today.getDate());
    if(data[tk]!=="success"){
        streakBox.textContent="ğŸ”¥ 0 Tage Streak";
        return;
    }
    let s=0;
    for(let d=today.getDate();d>=1;d--){
        if(data[keyFor(d)]==="success")s++; else break;
    }
    streakBox.textContent=`ğŸ”¥ ${s} Tage Streak`;
}

/* ===== SAVE ===== */
btnYes.onclick=()=>save("success");
btnNo.onclick=()=>save("fail");
function save(v){
    const k=keyFor(today.getDate());
    if(data[k])return;
    data[k]=v;
    db.collection("users").doc(auth.currentUser.uid)
      .set({streakData:data},{merge:true});
}

/* ===== GIFT ===== */
function checkGift(){
    for(let d=1;d<=daysInMonth;d++){
        if(data[keyFor(d)]!=="success"){
            giftBox.textContent="ğŸ”’ Geschenk gesperrt";
            return;
        }
    }
    giftBox.textContent="ğŸ Geschenk freigeschaltet ğŸ’–";
}

/* ===== ADMIN ===== */
const adminToggle=document.getElementById("adminToggle");
function updateAdminUI(){
    adminToggle.textContent=isAdmin?"ğŸ‘‘ Admin: AN":"ğŸ‘‘ Admin: AUS";
}
adminToggle.onclick=()=>{
    isAdmin=!isAdmin;
    localStorage.setItem("rabsiAdmin",isAdmin?"1":"0");
    updateAdminUI();
};

/* ===== ADMIN EDIT ===== */
async function adminEditProgress(){
    try{
        if(!isAdmin){alert("Kein Admin");return;}
        const email=document.getElementById("editEmail").value.trim();
        const date=document.getElementById("editDate").value;
        const value=document.getElementById("editValue").value;
        if(!email||!date){alert("E-Mail & Datum");return;}

        const d=new Date(date+"T12:00:00");
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

        const snap=await db.collection("users").where("email","==",email).limit(1).get();
        if(snap.empty){alert("Account nicht gefunden");return;}

        const doc=snap.docs[0];
        const raw=doc.data();
        const userData=raw.streakData?{...raw.streakData}:{};

        if(value==="") delete userData[key];
        else userData[key]=value;

        await db.collection("users").doc(doc.id).set({
            email:raw.email||email,
            streakData:userData
        },{merge:true});

        alert("âœ… Progress gesetzt");
    }catch(err){
        alert(err.message);
    }
}

/* ===== MODALS ===== */
function openStats(){statsModal.style.display="flex";buildStats();}
function closeStats(){statsModal.style.display="none";}
function openAccount(){accountModal.style.display="flex";}
function closeAccount(){accountModal.style.display="none";}

/* ===== STATS ===== */
function buildStats(){
    monthSelect.innerHTML="";
    const months=[...new Set(Object.keys(data).map(k=>k.slice(0,7)))];
    months.forEach(m=>{
        const o=document.createElement("option");
        o.value=m;o.textContent=m;
        monthSelect.appendChild(o);
    });
    monthSelect.onchange=()=>renderStats(monthSelect.value);
    renderStats(monthSelect.value);
}
function renderStats(m){
    statsGrid.innerHTML="";
    let s=0,f=0;
    if(!m)return;
    const [y,mo]=m.split("-").map(Number);
    const dim=new Date(y,mo,0).getDate();
    for(let d=1;d<=dim;d++){
        const k=`${y}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const c=document.createElement("div");
        c.textContent=d;
        if(data[k]==="success"){c.style.background="#4cd964";s++;}
        if(data[k]==="fail"){c.style.background="#ff5c5c";f++;}
        statsGrid.appendChild(c);
    }
    statsSummary.innerHTML=`ğŸŸ¢ ${s} clean<br>ğŸ”´ ${f} gekaut`;
}

/* ===== LOGOUT ===== */
function logout(){auth.signOut();}
</script>
</body>
</html>
